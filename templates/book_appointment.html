{% extends 'base.html' %}
{% block title %}Book Appointment ¬∑ DentalCare{% endblock %}
{% block content %}
<section class="hero"><div class="hero-bg"></div></section>
<div class="container">
  {% for m in get_flashed_messages(with_categories=true) %}
    <div class="flash {{ m[0] }}">{{ m[1] }}</div>
  {% endfor %}

  <div class="admin-hero" style="margin-bottom: 2rem;">
    {% if user and user.acc_role == 'Customer' %}
      <span class="badge" style="background: rgba(34, 197, 94, 0.2); color: var(--success);">New Appointment</span>
    {% else %}
      <span class="badge">Guest Booking</span>
    {% endif %}
    <h1 class="strong" style="margin: 0;">Schedule Your Visit</h1>
  </div>

  <div style="max-width: 820px; margin: 0 auto;">
    <form method="post" class="form glass" style="padding: 2.5rem;">
      <div class="grid2" style="gap: 2rem;">
        <!-- Left Column: Form Fields -->
        <div>
          <h3 style="margin-top: 0; color: var(--fg);">Your Information</h3>

          <label>Full Name
            <input name="name" placeholder="John Doe" required {% if customer_info %}value="{{ customer_info.name }}" readonly style="background: rgba(255, 255, 255, 0.5); cursor: not-allowed;"{% endif %}>
          </label>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <label>Contact
              <input name="contact" type="tel" placeholder="(+63)000 000-0000" required {% if customer_info %}value="{{ customer_info.contact }}" readonly style="background: rgba(255, 255, 255, 0.5); cursor: not-allowed;"{% endif %}>
            </label>
            <label>Age
              <input type="number" name="age" min="1" max="150" placeholder="Age" required>
            </label>
          </div>

          <label>Address
            <input name="address" placeholder="Street, City, Province" required>
          </label>

          <h3 style="margin-top: 2rem; color: var(--fg);">Appointment Details</h3>

          <label>Select Dentist
            <select name="dentist_id" id="dentist-select" required style="padding: 0.8rem 1rem; border-radius: 0.6rem; border: 1px solid var(--border); background: rgba(255, 255, 255, 0.85); font-size: 1rem;">
              <option value="">Choose a dentist...</option>
              {% for d in dentists %}
              <option value="{{ d.acc_id }}">{{ d.acc_name }}</option>
              {% endfor %}
            </select>
          </label>

          <label>Preferred Date
            <input type="date" name="app_date" id="app-date" min="{{ min_date }}" required style="padding: 0.8rem 1rem; border-radius: 0.6rem; border: 1px solid var(--border); background: rgba(255, 255, 255, 0.85); font-size: 1rem;">
          </label>

          <label>Select Time
            <select name="app_time" id="time-select" required style="padding: 0.8rem 1rem; border-radius: 0.6rem; border: 1px solid var(--border); background: rgba(255, 255, 255, 0.85); font-size: 1rem;">
              <option value="">Select dentist & date first...</option>
            </select>
          </label>

          <label>Service Type
            <select name="app_service" id="service-select" required style="padding: 0.8rem 1rem; border-radius: 0.6rem; border: 1px solid var(--border); background: rgba(255, 255, 255, 0.85); font-size: 1rem;">
              <option value="">Select service...</option>
              {% for s in services %}
              <option value="{{ s.service_name }}" data-price="{{ s.service_price }}">{{ s.service_name }} - ‚Ç±{{ "%.2f"|format(s.service_price) }}</option>
              {% endfor %}
            </select>
          </label>
        </div>

        <!-- Right Column: Summary & CTA -->
        <div>
          <div style="position: sticky; top: 100px;">
            <div class="panel" style="background: linear-gradient(135deg, rgba(0, 167, 167, 0.1), rgba(18, 130, 255, 0.08)); border: 1px solid rgba(0, 167, 167, 0.2); margin-bottom: 1.5rem;">
              <h3 style="margin-top: 0; color: var(--fg);">Appointment Summary</h3>

              <div style="display: grid; gap: 1rem; color: var(--muted); font-size: 0.95rem;">
                <div style="padding: 0.75rem; background: rgba(255, 255, 255, 0.5); border-radius: 0.5rem;">
                  <p style="margin: 0 0 0.25rem; font-size: 0.8rem; color: var(--muted);">Patient</p>
                  <p id="summary-name" style="margin: 0; font-weight: 600; color: var(--fg);">‚Äî</p>
                </div>

                <div style="padding: 0.75rem; background: rgba(255, 255, 255, 0.5); border-radius: 0.5rem;">
                  <p style="margin: 0 0 0.25rem; font-size: 0.8rem; color: var(--muted);">Dentist</p>
                  <p id="summary-dentist" style="margin: 0; font-weight: 600; color: var(--fg);">‚Äî</p>
                </div>

                <div style="padding: 0.75rem; background: rgba(255, 255, 255, 0.5); border-radius: 0.5rem;">
                  <p style="margin: 0 0 0.25rem; font-size: 0.8rem; color: var(--muted);">Date & Time</p>
                  <p id="summary-datetime" style="margin: 0; font-weight: 600; color: var(--fg);">‚Äî</p>
                </div>

                <div style="padding: 0.75rem; background: rgba(255, 255, 255, 0.5); border-radius: 0.5rem;">
                  <p style="margin: 0 0 0.25rem; font-size: 0.8rem; color: var(--muted);">Service</p>
                  <p id="summary-service" style="margin: 0; font-weight: 600; color: var(--fg);">‚Äî</p>
                </div>
              </div>
            </div>

            <div style="background: rgba(0, 167, 167, 0.1); border: 1px solid rgba(0, 167, 167, 0.2); border-radius: 0.8rem; padding: 1.25rem; margin-bottom: 1.5rem;">
              <p style="margin: 0 0 0.75rem; font-weight: 600; color: var(--fg); font-size: 0.95rem;">üí≥ Total Payment</p>
              <h2 style="margin: 0; color: var(--primary); font-size: 2.2rem;">‚Ç±<span id="total-price">0.00</span></h2>
              <p style="margin: 0.5rem 0 0; font-size: 0.85rem; color: var(--muted);">Philippine Peso (‚Ç±)</p>
            </div>

            <button class="btn btn-primary" type="submit" style="width: 100%;">Proceed to Payment</button>

            <p style="text-align: center; color: var(--muted); font-size: 0.85rem; margin-top: 1rem;">
              <a href="/" style="color: var(--primary); text-decoration: none;">‚Üê Back to home</a>
            </p>
          </div>
        </div>
      </div>
    </form>
  </div>

  <script>
    const nameInput = document.querySelector('input[name="name"]');
    const dentistSelect = document.getElementById('dentist-select');
    const dateInput = document.getElementById('app-date');
    const timeSelect = document.getElementById('time-select');
    const serviceSelect = document.getElementById('service-select');
    const totalPrice = document.getElementById('total-price');

    const summaryName = document.getElementById('summary-name');
    const summaryDentist = document.getElementById('summary-dentist');
    const summaryDateTime = document.getElementById('summary-datetime');
    const summaryService = document.getElementById('summary-service');

    async function loadAvailableTimes() {
      if (!dentistSelect.value || !dateInput.value) {
        timeSelect.innerHTML = '<option value="">Select dentist & date first...</option>';
        return;
      }

      try {
        const response = await fetch(`/api/available-times/${dentistSelect.value}/${dateInput.value}`);
        const data = await response.json();

        timeSelect.innerHTML = '<option value="">Select a time...</option>';
        if (data.times.length === 0) {
          timeSelect.innerHTML += '<option disabled>No available times</option>';
        } else {
          data.times.forEach(time => {
            const [hours, mins] = time.split(':');
            const period = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            const displayTime = `${displayHours.toString().padStart(2, '0')}:${mins} ${period}`;
            const option = document.createElement('option');
            option.value = time;
            option.textContent = displayTime;
            timeSelect.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading times:', error);
        timeSelect.innerHTML = '<option>Error loading times</option>';
      }
    }

    async function loadServicesByDentist() {
      if (!dentistSelect.value) {
        serviceSelect.innerHTML = '<option value="">Select dentist first...</option>';
        return;
      }

      try {
        const response = await fetch(`/api/services/${dentistSelect.value}`);
        const data = await response.json();

        serviceSelect.innerHTML = '<option value="">Select service...</option>';
        data.services.forEach(service => {
          const option = document.createElement('option');
          option.value = service.service_name;
          option.setAttribute('data-price', service.service_price);
          option.textContent = `${service.service_name} - ‚Ç±${parseFloat(service.service_price).toFixed(2)}`;
          serviceSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading services:', error);
        serviceSelect.innerHTML = '<option>Error loading services</option>';
      }
    }

    const updateSummary = () => {
      summaryName.textContent = nameInput.value || '‚Äî';

      const dentistOption = dentistSelect.options[dentistSelect.selectedIndex];
      summaryDentist.textContent = dentistOption.value ? dentistOption.text : '‚Äî';

      if (dateInput.value && timeSelect.value) {
        const date = new Date(dateInput.value);
        const dateStr = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        const [hours, mins] = timeSelect.value.split(':');
        const period = hours >= 12 ? 'PM' : 'AM';
        const displayHours = hours % 12 || 12;
        const timeStr = `${displayHours.toString().padStart(2, '0')}:${mins} ${period}`;
        summaryDateTime.textContent = `${dateStr}, ${timeStr}`;
      } else {
        summaryDateTime.textContent = '‚Äî';
      }

      const serviceOption = serviceSelect.options[serviceSelect.selectedIndex];
      if (serviceOption.value) {
        const price = parseFloat(serviceOption.getAttribute('data-price'));
        summaryService.textContent = serviceOption.text;
        totalPrice.textContent = price.toFixed(2);
      } else {
        summaryService.textContent = '‚Äî';
        totalPrice.textContent = '0.00';
      }
    };

    nameInput.addEventListener('input', updateSummary);
    dentistSelect.addEventListener('change', () => {
      loadAvailableTimes();
      loadServicesByDentist();
      updateSummary();
    });
    dateInput.addEventListener('change', () => {
      loadAvailableTimes();
      updateSummary();
    });
    timeSelect.addEventListener('change', updateSummary);
    serviceSelect.addEventListener('change', updateSummary);

    // Call updateSummary on page load to show pre-filled customer info
    updateSummary();
  </script>
</div>
{% endblock %}
